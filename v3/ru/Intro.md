---
title: Введение
layout: default
---
# Введение #

Приложение iikoFront поддерживает расширение функционала с помощью плагинов. Используя специальный программный интерфейс (Api), можно изменять поведение приложения в определённых сценариях, при печати чеков можно дополнять их своей информацией, при вводе заказа можно дублировать его состав на второй монитор (для покупателя), можно реализовать интеграцию с внешними системами приёма заказов (веб-сайты, электронные меню, мобильные терминалы официантов), собирать статистику и строить отчёты, подключить внешние платёжные системы и многое другое.

Для того чтобы создать плагин, можно использовать любой язык программирования из [.Net-семейства](http://en.wikipedia.org/wiki/List_of_CLI_languages), на выходе должна быть сборка под .Net 4.0, которую iikoFront загрузит при запуске. Для загрузки каждого плагина iikoFront создаёт отдельный процесс-контейнер и загружает плагин в него, это позволяет избежать конфликтов зависимостей и обеспечивает надёжность системы (сбой в одном из плагинов не обрушит всё остальное). Плагины устанавливаются в папку `Plugins` рядом с исполняемыми файлами приложения iikoFront. Сборка плагина должна содержать класс, имеющий публичный конструктор по умолчанию (без параметров) и реализующий интерфейс `IFrontPlugin`. Взаимодействие между процессами плагина и приложения iikoFront осуществляется через IPC-канал, передача объектов происходит либо по ссылке (в случае самого плагина, сервисов, такие объекты должны наследоваться от [`MarshalByRefObject`](http://msdn.microsoft.com/en-us/library/system.marshalbyrefobject(v=vs.100).aspx)), либо по значению (классы данных, они должны быть сериализуемыми). 

Точкой входа является метод `Init`, который вызывается при загрузке плагина, в этот метод передаётся набор сервисов, с помощью которых можно получить необходимые данные, подписаться на интересующие события и начать работу. Метод `Dispose` вызывается перед остановкой работы и выгрузкой плагина, он предназначен для отписки от событий и освобождения ресурсов.

## Основные контракты ##

### Структуры данных ###
Данные собраны в пространстве имён `Resto.Front.Api.V3.Data` и сгруппированы по направлениям:

- `Organization` — структура предприятия и его настройки,
- `Assortment` — номенклатура меню,
- `Orders` — заказы, включая гостей, блюда, модификаторы, скидки и т. п.,
- `Kitchen` — кухонные заказы,
- `Brd` — аббревиатура от «банкеты, резервы и доставки»,
- `Security` — данные, необходимые для авторизации плагина,
- `Licensing` — управление лицензиями,
- ...

В основном объекты данных доступны только для чтения — для них публикуется интерфейс с get-only свойствами, так что плагин не может создавать новые экземпляры таких объектов или изменять значения полей существующих. Многие объекты, например, `IProduct`, `ITable` или `IUser`, нельзя редактировать в принципе, это справочники, задаваемые через приложение iikoOffice. Некоторые типы объектов можно [редактировать](Data%20editing.md) опосредованно путём применения к ним тех или иных действий. Наконец, существует специальная категория объектов, расположенных в пространстве имён `Resto.Front.Api.V3.Data.DataTransferObjects`, которые могут быть созданы и отредактированы на стороне плагина.

Поскольку объекты передаются по значению путём сериализации корневого объекта и рекурсивно всех вложенных в него объектов, потенциально размер передаваемого графа объектов может оказаться очень большим. Если представить, что такие структуры данных передаются целиком и плагин хочет всего лишь проверить статус заказа, вместе с заказом он получит коллекцию блюд, для каждого блюда — коллекцию модификаторов, у всех блюд и модификаторов по продукту, те, в свою очередь, имеют ссылку на родительскую группу, а там коллекция всех продуктов группы, каждый из которых содержит список отделений, в меню которых продукт включён, и так далее. Для того чтобы избежать сериализации и передачи чрезмерного объёма данных, свойства объектов, которые нужны далеко не всегда, по умолчанию не передаются, их можно получить отдельным запросом. Например, вместе с заказом будут переданы такие его неотъемлемые атрибуты как номер, статус или официант, а списки гостей, блюд или платежей необходимо запросить дополнительно.

### Сервис операций ###
Практически все действия выполняются через `IOperationService`. Входящие в состав этого интерфейса методы можно разделить на группы:

- чтение данных — получение всех объектов некоторого типа (`GetProductGroups`), получение конкретного объекта (`GetProductGroupById`), получение связанных объектов (`GetChildGroupsByProductGroup`),
- изменение данных — одиночные действия (`PrintBillCheque`), пакетные действия (через `CreateEditSession`),
- другие операции — отображение сообщений (`AddWarningMessage`), проверка прав (`CheckCanEditOrder`) и прочие.    

### Сервис уведомлений ###
`INotificationService` позволяет подписаться на интересующие события — изменение данных, печать чеков, навигация между экранами и прочие. Этот сервис реализован с использованием библиотеки [Reactive Extensions (Rx)](http://msdn.microsoft.com/en-us/data/gg577609.aspx), события публикуются в виде `IObservable<T>`-последовательностей, где `T` — аргумент события (изменившийся объект, печатаемый чек и так далее). Rx позволяет работать с потоком событий так же удобно, как LINQ с `IEnumerable<T>`. Для знакомства с возможностями реактивного программирования есть хороший ресурс [Introduction to Rx](http://www.introtorx.com/).      

## Примеры ##

Помимо прочего в состав SDK входит несколько примеров плагинов в исходных кодах. Имеет смысл ознакомиться с ними, прежде чем приступать к разработке собственного плагина.

### SamplePlugin ###
Данный пример демонстрирует различные сценарии использования Api:

- дополнение чеков рекламной информацией,
- работа с заказами (создание заказа, добавление гостей, добавление и удаление блюд и модификаторов, изменение количества порций, печать сервисного чека и пречека, оплата и прочее),
- работа с доставками,
- работа с банкетами и резервами,
- работа со справочниками клиентов, улиц,
- отображение немодальных уведомлений на экране терминала,
- просмотр структуры предприятия (залы, столы, сотрудники),
- просмотр иерархического меню,
- просмотр статистики о работе кухни,
- управление лицензионными подключениями,
- регистрация дополнительных операций в меню iikoFront, 
- ...

### CustomerScreenPlugin ###
Этот пример представляет собой готовую реализацию экрана покупателя для терминалов с двумя мониторами, где на основном мониторе, обращённом к кассиру, развёрнуто приложение iikoFront, а на дополнительном мониторе находящемся со стороны покупателя, демонстрируются логотип предприятия и рекламные видеоролики, в упрощённом виде отображается состав текущего заказа.

## Контакты ##

- [api.iiko.ru](http://api.iiko.ru)
- [api@iiko.ru](mailto:api@iiko.ru)