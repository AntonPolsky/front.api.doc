---
title: Лицензирование
layout: default
---
# Лицензирование #

Разработчикам плагинов предоставляется возможность защитить их от несанкционированного использования. Иными словами, лицензирование является добровольным, решение о защите плагина принимает его разработчик. Однако, использование некоторых возможностей Api невозможно без соответствующей лицензии.

## Схемы лицензирования ##

Существует три основных подхода к защите плагина:

- Свободное использование: плагин может быть использован без ограничений.
- Плата за плагин: ограничивается количество одновременно работающих экземпляров плагина.
- Плата за внешнее подключение к плагину: ограничивается количество одновременно работающих с плагином клиентов (устройств).

Кроме того, возможно совмещение второго и третьего вариантов.

Для распространения плагина по схеме свободного использования дополнительные действия не требуются ни со стороны разработчика плагина, ни со стороны пользователя. В остальных случаях разработчику необходимо зарегистрировать свой плагин как лицензируемый модуль в iiko, а пользователю получить лицензию на использование этого модуля. При регистрации плагину назначается уникальный идентификатор (целое число), это и будет идентификатором модуля. Пользователю же необходимо получить лицензию, включающую в себя соответствующий модуль. Помимо самого факта включения модуля в лицензию могут быть установлены дополнительные ограничения, основное из которых — количество слотов. Слот модуля — это своего рода ячейка, которую на время может занять клиент. Работая попеременно, два клиента могут обходиться одним слотом, по очереди занимая и освобождая его, но для одновременной работы им понадобится два слота.

## Плата за плагин ##

Данный вариант может применяться для плагинов, предоставляющих законченный функционал и представляющих самостоятельную ценность. Например, плагин, дублирующий состав текущего заказа на экран покупателя, мог бы лицензироваться по этой схеме. Контроль лицензий осуществляется автоматически приложением iikoFront, плагин будет загружен только при наличии лицензии на него. Для одновременного использования плагина на нескольких терминалах требуется лицензия на соответствующее количество плагинов. Так, если плагин должен быть установлен на 10 терминалов, потребуется лицензия на 10 экземпляров плагина.

Чтобы защитить плагин по этой схеме, необходимо:

- Зарегистрироваться в iiko для получения идентификатора лицензируемого модуля.
- Пометить класс плагина атрибутом `PluginLicenseModuleId`, указав полученный при регистрации идентификатор.

## Плата за внешнее подключение к плагину ##
Данная схема применима для плагинов, которые являются посредниками между iikoFront и внешними клиентами. За контроль лицензий в таком случае отвечает плагин. Например, если плагин обеспечивает работу мобильных терминалов на предприятии, состоящем из двух групп отделений, в каждой из которых установлено по одному экземпляру плагина, и в обеих группах используется по 5 мобильных терминалов, то необходима лицензия на 10 клиентов. Количество работающих экземпляров плагина при этом не учитывается.

Для реализации этой схемы защиты необходимо:

- Зарегистрироваться в iiko для получения идентификатора лицензируемого модуля.
- Реализовать возможность идентификации подключающихся клиентов (устройств) таким образом, чтобы одному клиенту всегда соответствовал один и тот же идентификатор.
- При установке внешнего подключения вызвать метод `AcquireSlot` сервиса `ILicensingService`, указав полученный при регистрации идентификатор модуля и идентификатор подключающегося клиента. Запомнить ссылку на возвращённый методом объект `ILicenseSlot`.
- При завершении внешнего подключения вызвать метод `ReleaseSlot` сервиса `ILicensingService`, указав полученный при установке подключения объект `ILicenseSlot`.

При вызове `AcquireSlot` один из слотов модуля плагина отмечается занятым указанным клиентом. Если свободных слотов нет, метод генерирует исключение `InsufficientLicenseException`, значит, уже подключено максимально разрешённое количество клиентов, и очередному клиенту в подключении должно быть отказано.

Необходимо учитывать, что возможность освободить слот есть не всегда: работа плагина или приложения iikoFront может быть прервана внезапным выключением питания компьютера, возможны сетевые проблемы (манипуляции с лицензиями могут требовать сетевого взаимодействия) и прочее. Чтобы избежать «утечки» слотов, когда они занимаются, но не освобождаются, важно обеспечить неизменную идентификацию клиентов. Например, если некий клиент подключился к плагину, заняв один слот, а после внезапной перезагрузки этот клиент подключается снова, то, имея прежний идентификатор, он повторно займёт свой слот, а будь у него новый идентификатор, ему бы понадобился ещё один слот, а первый слот навсегда остался бы занятым.

## Регистрация ##
Для заключения договора и получения идентификатора лицензируемого модуля необходимо заполнить [анкету](http://api.iiko.ru/html_doc/WDoc/ConnectProgram.docx) и отправить её по адресу [api@iiko.ru](mailto:api@iiko.ru).